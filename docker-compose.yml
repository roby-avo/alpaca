services:
  postgres:
    image: postgres:${ALPACA_POSTGRES_VERSION:-18.1}
    pull_policy: always
    environment:
      POSTGRES_DB: ${ALPACA_POSTGRES_DB:-alpaca}
      POSTGRES_USER: ${ALPACA_POSTGRES_USER:-postgres}
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "${ALPACA_POSTGRES_PORT:-5432}:5432"
    volumes:
      - type: bind
        source: ${ALPACA_POSTGRES_DATA_DIR:-./data/postgres}
        target: /var/lib/postgresql

  adminer:
    image: adminer:${ALPACA_ADMINER_VERSION:-5}
    pull_policy: always
    depends_on:
      - postgres
    environment:
      ADMINER_DEFAULT_SERVER: ${ALPACA_ADMINER_DEFAULT_SERVER:-postgres}
    ports:
      - "${ALPACA_ADMINER_PORT:-8080}:8080"

  api:
    build:
      context: .
    image: alpaca:latest
    working_dir: /workspace
    command: ["uvicorn", "src.api:app", "--host", "0.0.0.0", "--port", "8000"]
    depends_on:
      - postgres
    environment:
      ALPACA_DUMP_PATH: ${ALPACA_DUMP_PATH:-/mnt/input/latest-all.json.bz2}
      ALPACA_NER_TYPES_PATH: ${ALPACA_NER_TYPES_PATH:-}
      ALPACA_LABELS_DB_PATH: ${ALPACA_LABELS_DB_PATH:-/workspace/data/output/wikidata_labels.sqlite}
      ALPACA_BOW_OUTPUT_PATH: ${ALPACA_BOW_OUTPUT_PATH:-/workspace/data/output/bow_docs.jsonl.gz}
      ALPACA_POSTGRES_DSN: ${ALPACA_POSTGRES_DSN:-postgresql://postgres@postgres:5432/alpaca}
    ports:
      - "${ALPACA_API_PORT:-8000}:8000"
    volumes:
      - type: bind
        source: ${ALPACA_INPUT_DIR:-./data/input}
        target: /mnt/input
        read_only: true
      - type: bind
        source: ${ALPACA_OUTPUT_DIR:-./data/output}
        target: /workspace/data/output
      - type: bind
        source: ./src
        target: /workspace/src
        read_only: true
      - type: bind
        source: ./scripts
        target: /workspace/scripts
        read_only: true
